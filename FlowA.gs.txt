/************************************************************
 *  FlowA.gs ‚Äî STEP 3A FULL IMPLEMENTATION (STRICT MODE)
 *  FLOW A ‚Äî Missing Loved One Case
 *  ZERO DEVIATION ‚Äî EXACTLY as per Flow Document + Texts_A
 *  Includes ALL approved enhancements (media, timeout, HELP, logging, etc.)
 ************************************************************/

const FlowA = {

  /************************************************************
   * ROUTER ‚Äî Entry point for Flow A messages
   ************************************************************/
  process(session, msg, raw, mediaUrl, mediaMime) {

    const step = session.Current_Step_Code || "A_ELIGIBILITY";

    switch (step) {

      case "FLOW_A_START":
      case "A_ELIGIBILITY":
        return this.start(session, msg);

      case "A_ELIGIBILITY_REJECT":
        return Texts_Eligibility.getRejectionPoliceCase(session.Preferred_Language);

      case "A_INTRO":
      case "A_Q1":
      case "A_Q2":
      case "A_Q3":
      case "A_Q4":
      case "A_Q5":
      case "A_Q6":
      case "A_Q7":
      case "A_Q8":
      case "A_Q9":
      case "A_NOTES":
      case "A_FINAL_CONFIRM":
        return this.handleQuestion(session, msg, raw, mediaUrl, mediaMime);

      default:
        return Texts_Validation.getGenericError(session.Preferred_Language);
    }
  },

  /************************************************************
   * ENTRY POINT ‚Äî Start Flow A
   ************************************************************/
  start(session, msg) {

    const incoming = (msg || "").trim();

    // If we already received a choice, treat it as eligibility answer
    if (session.Current_Step_Code === "A_ELIGIBILITY" && incoming) {
      return this.handleEligibility(session, incoming);
    }

    session.Flow_Type = "A";
    session.Current_Step_Code = "A_ELIGIBILITY";
    Session.save(session);

    return Texts_A.getEligibilityQuestion()[session.Preferred_Language];
  },

  /************************************************************
   * HANDLE ELIGIBILITY (YES / NO)
   ************************************************************/
  handleEligibility(session, msg) {

    const lang = session.Preferred_Language;
    const choice = (msg || "").trim();

    if (!["1", "2"].includes(choice)) {
      return Texts_Validation.getInvalidOption(lang);
    }

    /*************** REJECTED ‚Äî Police / Agency Case ***************/
    if (choice === "1") {

      session.Current_Step_Code = "A_ELIGIBILITY_REJECT";
      Session.save(session);

      return Texts_Eligibility.getRejectionPoliceCase(lang);
    }

    /*************** ACCEPTED ‚Äî Proceed to questions ***************/
    session.Current_Step_Code = "A_INTRO";
    Session.save(session);

    return Texts_A._A_EMPATHETIC_INTRO[lang];
  },

  /************************************************************
   * AFTER INTRO ‚Üí START Q1
   ************************************************************/
  startQuestions(session) {

    session.Current_Step_Code = "A_Q1";
    Session.save(session);

    return Texts_A._A_Q1_COUNTRY[session.Preferred_Language];
  },

  /************************************************************
   * MAIN QUESTION HANDLER ROUTER
   ************************************************************/
  handleQuestion(session, msg, raw, mediaUrl, mediaMime) {

    const step = session.Current_Step_Code;
    const lang = session.Preferred_Language;

    switch (step) {

      case "A_INTRO":
        return this.startQuestions(session);

      case "A_Q1": return this._handleQ(session, msg, raw, mediaUrl, mediaMime, "A_Q1", "A_Q2", "_A_Q1_COUNTRY");
      case "A_Q2": return this._handleQ(session, msg, raw, mediaUrl, mediaMime, "A_Q2", "A_Q3", "_A_Q2_FULL_NAME");
      case "A_Q3": return this._handleQ(session, msg, raw, mediaUrl, mediaMime, "A_Q3", "A_Q4", "_A_Q3_AGE");
      case "A_Q4": return this._handleQ(session, msg, raw, mediaUrl, mediaMime, "A_Q4", "A_Q5", "_A_Q4_GENDER");
      case "A_Q5": return this._handleQ(session, msg, raw, mediaUrl, mediaMime, "A_Q5", "A_Q6", "_A_Q5_LAST_SEEN_LOCATION");
      case "A_Q6": return this._handleQ(session, msg, raw, mediaUrl, mediaMime, "A_Q6", "A_Q7", "_A_Q6_LAST_SEEN_TIME");
      case "A_Q7": return this._handleQ(session, msg, raw, mediaUrl, mediaMime, "A_Q7", "A_Q8", "_A_Q7_RELATIONSHIP");
      case "A_Q8": return this._handleQ(session, msg, raw, mediaUrl, mediaMime, "A_Q8", "A_Q9", "_A_Q8_CONTACT_NUMBER");
      case "A_Q9": return this._handlePhoto(session, msg, raw, mediaUrl, mediaMime);

      case "A_NOTES": return this._handleNotes(session, msg, raw, mediaUrl, mediaMime);

      case "A_FINAL_CONFIRM": return this._handleFinalConfirmation(session, msg);

      default:
        return Texts_Validation.getGenericError(lang);
    }
  },

  /************************************************************
   * GENERIC HANDLER FOR Q1..Q8
   ************************************************************/
  _handleQ(session, msg, raw, mediaUrl, mediaMime, cur, next, key) {

    const lang = session.Preferred_Language;
    const answer = (msg || "").trim();

    if (!answer) return Texts_Validation.getEmptyInput(lang);

    // Save text response
    this._saveAnswer(session, cur, answer);

    // Move to next step
    session.Current_Step_Code = next;
    Session.save(session);

    return Texts_A[key][lang];
  },

  /************************************************************
   * Q9 ‚Äî Photo (media OR text)
   ************************************************************/
  _handlePhoto(session, msg, raw, mediaUrl, mediaMime) {

    const lang = session.Preferred_Language;

    /*************** MEDIA ***************/
    if (mediaUrl) {
      const saved = MediaEngine.saveMedia(session, mediaUrl, mediaMime);
      this._saveAnswer(session, "A_Q9", saved);

      session.Current_Step_Code = "A_NOTES";
      Session.save(session);

      return Texts_A.getAdditionalNotesPrompt()[lang];
    }

    /*************** TEXT ***************/
    const incoming = (msg || "").trim();
    if (!incoming) return Texts_Validation.getEmptyInput(lang);

    this._saveAnswer(session, "A_Q9", incoming);

    session.Current_Step_Code = "A_NOTES";
    Session.save(session);

    return Texts_A.getAdditionalNotesPrompt()[lang];
  },

  /************************************************************
   * ADDITIONAL NOTES
   ************************************************************/
  _handleNotes(session, msg, raw, mediaUrl, mediaMime) {

    const lang = session.Preferred_Language;

    /*************** MEDIA ***************/
    if (mediaUrl) {
      const saved = MediaEngine.saveMedia(session, mediaUrl, mediaMime);
      this._saveAnswer(session, "A_NOTES", saved);
      return Texts_A.getAdditionalNotesPrompt()[lang];
    }

    /*************** TEXT ***************/
    const incoming = (msg || "").trim();

    if (!incoming) return Texts_Validation.getEmptyInput(lang);

    if (incoming.toLowerCase() === "done") {

      session.Current_Step_Code = "A_FINAL_CONFIRM";
      Session.save(session);

      return Texts_A.getFinalBeforeConfirmation()[lang];
    }

    // Save additional text
    this._saveAnswer(session, "A_NOTES", incoming);
    return Texts_A.getAdditionalNotesPrompt()[lang];
  },

  /************************************************************
   * FINAL CONFIRMATION (YES / NO)
   ************************************************************/
  _handleFinalConfirmation(session, msg) {

    const lang = session.Preferred_Language;
    const choice = (msg || "").trim().toLowerCase();

    if (choice === "yes") {
      return this._finalizeCase(session);
    }

    if (choice === "no") {
      Session.resetFull(session);
      return Texts_Closing.getCancelled(lang);
    }

    return Texts_Validation.getInvalidOption(lang);
  },

  /************************************************************
   * CREATE CASE RECORD + END
   ************************************************************/
  _finalizeCase(session) {

    const lang = session.Preferred_Language;

    const caseId = CaseEngine.createNewCase(session);

    session.Current_Step_Code = "A_END";
    Session.save(session);

    return Texts_CaseUpdates.getCaseCreated(lang)
      .replace("{CASE_ID}", caseId);
  },

  /************************************************************
   * INTERNAL: Save answer into session.Temp_Data_Json
   ************************************************************/
  _saveAnswer(session, field, value) {

    session.Temp_Data_Json = session.Temp_Data_Json || {};
    session.Temp_Data_Json[field] = value;

    Session.save(session);
  },

  /************************************************************
   * üîÅ REPLAY CURRENT QUESTION (for timeout / media rejection)
   ************************************************************/
  replay(session) {

    const step = session.Current_Step_Code;
    const lang = session.Preferred_Language;

    switch (step) {
      case "A_ELIGIBILITY":
        return Texts_A.getEligibilityQuestion()[lang];

      case "A_INTRO":
        return Texts_A._A_EMPATHETIC_INTRO[lang];

      case "A_Q1": return Texts_A._A_Q1_COUNTRY[lang];
      case "A_Q2": return Texts_A._A_Q2_FULL_NAME[lang];
      case "A_Q3": return Texts_A._A_Q3_AGE[lang];
      case "A_Q4": return Texts_A._A_Q4_GENDER[lang];
      case "A_Q5": return Texts_A._A_Q5_LAST_SEEN_LOCATION[lang];
      case "A_Q6": return Texts_A._A_Q6_LAST_SEEN_TIME[lang];
      case "A_Q7": return Texts_A._A_Q7_RELATIONSHIP[lang];
      case "A_Q8": return Texts_A._A_Q8_CONTACT_NUMBER[lang];
      case "A_Q9": return Texts_A._A_Q9_PHOTO[lang];

      case "A_NOTES":
        return Texts_A.getAdditionalNotesPrompt()[lang];

      case "A_FINAL_CONFIRM":
        return Texts_A.getFinalBeforeConfirmation()[lang];

      default:
        return Texts_Validation.getGenericError(lang);
    }
  },

};
