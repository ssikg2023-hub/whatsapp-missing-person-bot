/************************************************************
 *  ExistingCaseFlow.gs â€” STRICT MODE, FINAL REVISION
 *  Fully aligned with Flows.gs routing + timeout replay
 ************************************************************/

const ExistingCaseFlow = {

  _getLang(session) {
    return session.Preferred_Language || "English";
  },

  _setStep(session, stepCode) {
    session.Current_Step_Code = stepCode;
    SessionEngine.save(session);
  },

  /************************************************************
   * ENTRY POINT â†’ When user selects â€œExisting Caseâ€
   ************************************************************/
  start(session) {
    const lang = this._getLang(session);

    session.Flow_Type = "EXISTING_CASE";
    this._setStep(session, "EXISTING_CASE_SELECT");

    return (
      Texts_ExistingCases.getEntry(lang) +
      "\n\n" +
      Texts_ExistingCases.getCaseIdPrompt(lang)
    );
  },

  /************************************************************
   * STEP 1 â€” HANDLE CASE ID
   ************************************************************/
  handleCaseId(session, msg) {
    const lang = this._getLang(session);
    const caseId = (msg || "").trim();

    if (!caseId) return Texts_Validation.getEmptyInput(lang);

    // Lookup cases
    const matches = CaseEngine.findByCaseID(caseId, session.WhatsApp_Number);

    // Zero matches
    if (matches.length === 0) {
      return Texts_ExistingCases.getCaseNotFound(lang);
    }

    // Multiple
    if (matches.length > 1) {
      session.Temp_Data_Json = { MULTI_LIST: matches };
      this._setStep(session, "EXISTING_CASE_SELECT");

      let numberedList = "";
      matches.forEach((c, i) => {
        numberedList += `${i + 1}) ${c.Case_ID}\n`;
      });

      const menu = Texts_ExistingCases.getMultipleCasesList(lang);
      return menu + "\n\n" + numberedList.trim();
    }

    // Single
    const found = matches[0];
    return this._openCaseMenu(session, found);
  },

  /************************************************************
   * STEP 2 â€” HANDLE MULTIPLE CASE INDEX SELECTION
   ************************************************************/
  handleCaseIndexSelection(session, msg) {
    const lang = this._getLang(session);
    const n = parseInt((msg || "").trim(), 10);

    if (
      !session.Temp_Data_Json ||
      !Array.isArray(session.Temp_Data_Json.MULTI_LIST)
    ) {
      return Texts_Validation.getGenericError(lang);
    }

    const list = session.Temp_Data_Json.MULTI_LIST;

    if (isNaN(n) || n < 1 || n > list.length) {
      return Texts_Validation.getInvalidOption(lang);
    }

    const selected = list[n - 1];
    return this._openCaseMenu(session, selected);
  },

  /************************************************************
   * INTERNAL â€” OPEN MAIN MENU FOR CASE
   ************************************************************/
  _openCaseMenu(session, caseObj) {
    const lang = this._getLang(session);

    session.Selected_Case = caseObj;
    session.Flow_Type = "EXISTING_CASE";
    this._setStep(session, "EXISTING_CASE_MENU");

    return Texts_ExistingCases.getMenu(lang).replace(
      "{CASE_ID}",
      caseObj.Case_ID
    );
  },

  /************************************************************
   * STEP 3 â€” MAIN MENU HANDLER (1â€“4)
   ************************************************************/
  handleMainMenu(session, msg) {
    const lang = this._getLang(session);
    const choice = (msg || "").trim();

    if (!["1", "2", "3", "4"].includes(choice)) {
      return Texts_Validation.getInvalidOption(lang);
    }

    // 1 = Review
    if (choice === "1") {
      return this._handleReview(session);
    }

    // 2 = Status
    if (choice === "2") {
      return this._handleStatus(session);
    }

    // 3 = New Case
    if (choice === "3") {
      SessionEngine.resetPartial(session);
      session.Current_Step_Code = "USER_TYPE";
      SessionEngine.save(session);

      return Texts_ExistingCases.getSubmitNewCaseOption(lang);
    }

    // 4 = Update Case
    if (choice === "4") {
      return CaseUpdateFlow.start(session);
    }
  },

  /************************************************************
   * OPTION 1 â€” REVIEW CASE DETAILS
   ************************************************************/
  _handleReview(session) {
    const lang = this._getLang(session);
    const c = session.Selected_Case;

    const template = Texts_ExistingCases.getReviewOption(lang);
    const summary = CaseEngine.buildSummary(c, lang);

    return template + "\n\n" + summary;
  },

  /************************************************************
   * OPTION 2 â€” STATUS CHECK
   ************************************************************/
  _handleStatus(session) {
    const lang = this._getLang(session);
    const c = session.Selected_Case;

    const statusMsg = Texts_ExistingCases.getStatusOption(lang);
    return statusMsg.replace("{STATUS}", c.Case_Status || "Unknown");
  },

  /************************************************************
   * ðŸ”¹ REPLAY HELPERS (Timeout, HELP, MENU)
   ************************************************************/

  replayCaseId(session) {
    const lang = this._getLang(session);
    return (
      Texts_ExistingCases.getEntry(lang) +
      "\n\n" +
      Texts_ExistingCases.getCaseIdPrompt(lang)
    );
  },

  replayCaseIndexSelection(session) {
    const lang = this._getLang(session);
    const list = session.Temp_Data_Json?.MULTI_LIST || [];

    let numbered = "";
    list.forEach((c, i) => (numbered += `${i + 1}) ${c.Case_ID}\n`));

    return (
      Texts_ExistingCases.getMultipleCasesList(lang) +
      "\n\n" +
      numbered.trim()
    );
  },

  replayMainMenu(session) {
    const lang = this._getLang(session);
    const caseId = session.Selected_Case?.Case_ID || "";
    return Texts_ExistingCases.getMenu(lang).replace("{CASE_ID}", caseId);
  },

  replayMenu(session) {
    if (!session.Selected_Case) return this.replayCaseId(session);
    return this.replayMainMenu(session);
  },

  replayCaseSelection(session) {
    if (session.Temp_Data_Json?.MULTI_LIST?.length) {
      return this.replayCaseIndexSelection(session);
    }
    return this.replayCaseId(session);
  },

  /************************************************************
   * ROUTERS (align with Flows interceptors)
   ************************************************************/
  processCaseSelection(session, msg) {
    if (session.Temp_Data_Json?.MULTI_LIST?.length) {
      return this.handleCaseIndexSelection(session, msg);
    }
    return this.handleCaseId(session, msg);
  },

  processMenu(session, msg) {
    if (!session.Selected_Case) {
      return this.processCaseSelection(session, msg);
    }
    return this.handleMainMenu(session, msg);
  }

};
