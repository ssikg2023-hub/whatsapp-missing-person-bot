/************************************************************
 *  ExistingCaseFlow.gs â€” STRICT MODE, FINAL REVISION
 *  Fully aligned with Flows.gs routing + timeout replay
 ************************************************************/

const ExistingCaseFlow = {

  /************************************************************
   * ENTRY POINT â†’ When user selects â€œExisting Caseâ€
   ************************************************************/
  start(session) {
    const lang = session.Preferred_Language;

    session.Current_Step_Code = "EC_CASE_ID";
    Session.save(session);

    return (
      Texts_ExistingCases.getEntry()[lang] +
      "\n\n" +
      Texts_ExistingCases.getCaseIdPrompt()[lang]
    );
  },

  /************************************************************
   * STEP 1 â€” HANDLE CASE ID
   ************************************************************/
  handleCaseId(session, msg) {
    const lang = session.Preferred_Language;
    const caseId = (msg || "").trim();

    if (!caseId) return Texts_Validation.getEmptyInput(lang);

    // Lookup cases
    const matches = CaseEngine.findByCaseID(caseId, session.WhatsApp_Number);

    // Zero matches
    if (matches.length === 0) {
      return Texts_ExistingCases.getCaseNotFound()[lang];
    }

    // Multiple
    if (matches.length > 1) {
      session.Temp_Data_Json = { MULTI_LIST: matches };
      session.Current_Step_Code = "EC_SELECT_INDEX";
      Session.save(session);

      let numberedList = "";
      matches.forEach((c, i) => {
        numberedList += `${i + 1}) ${c.Case_ID}\n`;
      });

      const menu = Texts_ExistingCases.getMultipleCasesList()[lang];
      return menu + "\n\n" + numberedList.trim();
    }

    // Single
    const found = matches[0];
    return this._openCaseMenu(session, found);
  },

  /************************************************************
   * STEP 2 â€” HANDLE MULTIPLE CASE INDEX SELECTION
   ************************************************************/
  handleCaseIndexSelection(session, msg) {
    const lang = session.Preferred_Language;
    const n = parseInt((msg || "").trim(), 10);

    if (
      !session.Temp_Data_Json ||
      !Array.isArray(session.Temp_Data_Json.MULTI_LIST)
    ) {
      return Texts_Validation.getGenericError(lang);
    }

    const list = session.Temp_Data_Json.MULTI_LIST;

    if (isNaN(n) || n < 1 || n > list.length) {
      return Texts_Validation.getInvalidOption(lang);
    }

    const selected = list[n - 1];
    return this._openCaseMenu(session, selected);
  },

  /************************************************************
   * INTERNAL â€” OPEN MAIN MENU FOR CASE
   ************************************************************/
  _openCaseMenu(session, caseObj) {
    const lang = session.Preferred_Language;

    session.Selected_Case = caseObj;
    session.Current_Step_Code = "EC_MAIN_MENU";
    Session.save(session);

    return Texts_ExistingCases.getMenu()[lang].replace(
      "{CASE_ID}",
      caseObj.Case_ID
    );
  },

  /************************************************************
   * STEP 3 â€” MAIN MENU HANDLER (1â€“4)
   ************************************************************/
  handleMainMenu(session, msg) {
    const lang = session.Preferred_Language;
    const choice = (msg || "").trim();

    if (!["1", "2", "3", "4"].includes(choice)) {
      return Texts_Validation.getInvalidOption(lang);
    }

    // 1 = Review
    if (choice === "1") {
      return this._handleReview(session);
    }

    // 2 = Status
    if (choice === "2") {
      return this._handleStatus(session);
    }

    // 3 = New Case
    if (choice === "3") {
      Session.resetPartial(session);
      session.Current_Step_Code = "USER_TYPE";
      Session.save(session);

      return Texts_ExistingCases.getSubmitNewCaseOption()[lang];
    }

    // 4 = Update Case
    if (choice === "4") {
      return this._startUpdate(session);
    }
  },

  /************************************************************
   * OPTION 1 â€” REVIEW CASE DETAILS
   ************************************************************/
  _handleReview(session) {
    const lang = session.Preferred_Language;
    const c = session.Selected_Case;

    const template = Texts_ExistingCases.getReviewOption()[lang];
    const summary = CaseEngine.buildSummary(c, lang);

    return template + "\n\n" + summary;
  },

  /************************************************************
   * OPTION 2 â€” STATUS CHECK
   ************************************************************/
  _handleStatus(session) {
    const lang = session.Preferred_Language;
    const c = session.Selected_Case;

    const statusMsg = Texts_ExistingCases.getStatusOption()[lang];
    return statusMsg.replace("{STATUS}", c.Case_Status || "Unknown");
  },

  /************************************************************
   * OPTION 4 â€” BEGIN UPDATE CASE FLOW
   ************************************************************/
  _startUpdate(session) {
    const lang = session.Preferred_Language;

    session.Current_Step_Code = "EC_UPDATE_START";
    session.Temp_Data_Json = { UPDATE_ACCUM: {} };
    Session.save(session);

    return Texts_ExistingCases.getUpdateOption()[lang];
  },

  /************************************************************
   * UPDATE â€” FIELD SELECTION
   ************************************************************/
  handleUpdateSelection(session, msg) {
    const lang = session.Preferred_Language;
    const choice = (msg || "").trim();

    const prompts = Texts_ExistingCases.getUpdatePrompts();

    if (!prompts[choice]) {
      return Texts_Validation.getInvalidOption(lang);
    }

    session.Current_Step_Code = "EC_UPDATE_Q";
    session.Temp_Data_Json.LAST_FIELD = choice;
    Session.save(session);

    return prompts[choice][lang];
  },

  /************************************************************
   * UPDATE â€” HANDLE ANSWER (TEXT or MEDIA)
   ************************************************************/
  handleUpdateAnswer(session, msg, raw, mediaUrl, mediaMime) {
    const lang = session.Preferred_Language;

    const field = session.Temp_Data_Json.LAST_FIELD;
    if (!field) return Texts_Validation.getGenericError(lang);

    // MEDIA
    if (mediaUrl) {
      const saved = MediaEngine.saveMedia(session, mediaUrl, mediaMime);
      session.Temp_Data_Json.UPDATE_ACCUM[field] = saved;
      Session.save(session);

      return Texts_ExistingCases.getAreYouDone()[lang];
    }

    // TEXT
    const incoming = (msg || "").trim();
    if (!incoming) {
      return Texts_Validation.getEmptyInput(lang);
    }

    session.Temp_Data_Json.UPDATE_ACCUM[field] = incoming;
    Session.save(session);

    return Texts_ExistingCases.getAreYouDone()[lang];
  },

  /************************************************************
   * UPDATE â€” ARE YOU DONE (YES/NO)
   ************************************************************/
  handleUpdateDone(session, msg) {
    const lang = session.Preferred_Language;
    const choice = (msg || "").trim();

    if (choice === "1") {
      const caseId = session.Selected_Case.Case_ID;
      const updates = session.Temp_Data_Json.UPDATE_ACCUM;

      CaseEngine.appendUpdate(caseId, updates);

      session.Current_Step_Code = "EC_UPDATE_SUCCESS";
      Session.save(session);

      return Texts_ExistingCases.getUpdateSuccess()[lang];
    }

    if (choice === "2") {
      session.Current_Step_Code = "EC_UPDATE_START";
      Session.save(session);

      return Texts_ExistingCases.getUpdateOption()[lang];
    }

    return Texts_Validation.getInvalidOption(lang);
  },

  /************************************************************
   * ðŸ”¹ REPLAY HELPERS (Timeout, HELP, MENU)
   ************************************************************/

  replayCaseId(session) {
    const lang = session.Preferred_Language;
    return (
      Texts_ExistingCases.getEntry()[lang] +
      "\n\n" +
      Texts_ExistingCases.getCaseIdPrompt()[lang]
    );
  },

  replayCaseIndexSelection(session) {
    const lang = session.Preferred_Language;
    const list = session.Temp_Data_Json?.MULTI_LIST || [];

    let numbered = "";
    list.forEach((c, i) => (numbered += `${i + 1}) ${c.Case_ID}\n`));

    return (
      Texts_ExistingCases.getMultipleCasesList()[lang] +
      "\n\n" +
      numbered.trim()
    );
  },

  replayMainMenu(session) {
    const lang = session.Preferred_Language;
    const caseId = session.Selected_Case?.Case_ID || "";
    return Texts_ExistingCases.getMenu()[lang].replace("{CASE_ID}", caseId);
  },

  replayUpdateStart(session) {
    const lang = session.Preferred_Language;
    return Texts_ExistingCases.getUpdateOption()[lang];
  },

  replayUpdateQ(session) {
    const lang = session.Preferred_Language;
    const field = session.Temp_Data_Json?.LAST_FIELD;

    if (!field) return Texts_Validation.getGenericError(lang);

    const prompts = Texts_ExistingCases.getUpdatePrompts();
    return prompts[field][lang];
  },

  replayUpdateSuccess(session) {
    const lang = session.Preferred_Language;
    return Texts_ExistingCases.getUpdateSuccess()[lang];
  }

};
